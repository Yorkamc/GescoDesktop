import React from 'react';
import ReactDOM from 'react-dom/client';
import { BrowserRouter } from 'react-router-dom';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import App from './App';
import './styles/globals.css';

console.log('🚀 INICIANDO APLICACIÓN REACT');
console.log('React version:', React.version);
console.log('Location:', window.location.href);
console.log('User agent:', navigator.userAgent);

// Verificar que tenemos el elemento root
const rootElement = document.getElementById('root');
console.log('Root element found:', !!rootElement);
console.log('Root element details:', rootElement);

if (!rootElement) {
  console.error('❌ ERROR CRÍTICO: No se encontró el elemento #root');
  // Crear error page directamente en el body
  document.body.innerHTML = `
    <div style="padding: 20px; text-align: center; font-family: Arial, sans-serif; background: #fee2e2; min-height: 100vh; display: flex; align-items: center; justify-content: center;">
      <div style="background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h1 style="color: #dc2626; margin-bottom: 16px;">Error Crítico</h1>
        <p style="color: #7f1d1d; margin-bottom: 12px;">No se encontró el elemento root (#root)</p>
        <p style="color: #7f1d1d; font-size: 14px;">Verifica que index.html tenga un div con id="root"</p>
        <button onclick="location.reload()" style="background: #dc2626; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; margin-top: 16px;">Reintentar</button>
      </div>
    </div>
  `;
} else {
  console.log('✅ Elemento root encontrado, iniciando React...');

  const queryClient = new QueryClient({
    defaultOptions: {
      queries: {
        staleTime: 1000 * 60 * 5, // 5 minutos
        retry: 2,
      },
    },
  });

  try {
    console.log('📦 Creando root de React...');
    const root = ReactDOM.createRoot(rootElement);
    
    console.log('🎨 Renderizando aplicación...');
    root.render(
      <React.StrictMode>
        <QueryClientProvider client={queryClient}>
          <BrowserRouter>
            <App />
          </BrowserRouter>
        </QueryClientProvider>
      </React.StrictMode>
    );
    
    console.log('✅ React renderizado exitosamente');
    
    // Marcar que React se cargó y ocultar loading
    setTimeout(() => {
      document.body.classList.add('react-loaded');
      console.log('✅ Clase react-loaded agregada');
      
      // Verificar contenido del root
      const rootContent = document.getElementById('root')?.innerHTML;
      console.log('Root content length:', rootContent?.length || 0);
      
      if (!rootContent || rootContent.trim() === '') {
        console.error('❌ React renderizó pero no hay contenido en root');
      } else {
        console.log('✅ React ha renderizado contenido en root');
      }
    }, 1000);
    
  } catch (error) {
    console.error('❌ Error al renderizar React:', error);
    console.error('Stack trace:', (error as Error).stack);
    
    rootElement.innerHTML = `
      <div style="padding: 20px; text-align: center; font-family: Arial, sans-serif; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; margin: 20px;">
        <h2 style="color: #dc2626; margin-bottom: 16px;">Error al cargar la aplicación</h2>
        <p style="color: #7f1d1d; margin-bottom: 12px;">Se produjo un error al inicializar React:</p>
        <pre style="background: #fee2e2; padding: 12px; border-radius: 4px; text-align: left; overflow-x: auto; font-size: 12px; white-space: pre-wrap;">${(error as Error).message}</pre>
        <button onclick="location.reload()" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 16px;">Reintentar</button>
      </div>
    `;
  }
}

// Exportar una función global para debugging desde la consola
(window as any).debugReact = () => {
  console.log('=== DEBUG REACT ===');
  console.log('Root element:', document.getElementById('root'));
  console.log('Root content:', document.getElementById('root')?.innerHTML?.substring(0, 500));
  console.log('Body classes:', document.body.className);
  console.log('Scripts loaded:', document.scripts.length);
  console.log('Stylesheets loaded:', document.styleSheets.length);
  console.log('React loaded:', typeof React !== 'undefined');
  console.log('ReactDOM loaded:', typeof ReactDOM !== 'undefined');
};