# ====================================================
#  üì¶ GESCO DESKTOP - BUILD SCRIPT PARA PRODUCCI√ìN
# ====================================================
param(
    [string]$Configuration = "Release",
    [switch]$SkipTests = $false,
    [switch]$BuildElectron = $false,
    [switch]$Clean = $false
)

Write-Host "=============================================" -ForegroundColor Cyan
Write-Host "  üì¶ BUILDING GESCO DESKTOP - PRODUCCI√ìN" -ForegroundColor Cyan  
Write-Host "=============================================" -ForegroundColor Cyan

# Variables
$BackendProject = "backend/src/Gesco.Desktop.UI/Gesco.Desktop.UI.csproj"
$FrontendPath = "frontend"
$OutputPath = "dist"
$BackendOutput = "$OutputPath/backend"
$FrontendOutput = "$OutputPath/frontend"
$ElectronOutput = "$FrontendPath/dist-electron"

# Limpiar builds anteriores si se solicita
if ($Clean) {
    Write-Host "`nüßπ Limpiando builds anteriores..." -ForegroundColor Yellow
    
    if (Test-Path $OutputPath) {
        Remove-Item -Path $OutputPath -Recurse -Force
        Write-Host "   ‚úÖ Directorio dist/ limpiado" -ForegroundColor Green
    }
    
    if (Test-Path "$FrontendPath/dist") {
        Remove-Item -Path "$FrontendPath/dist" -Recurse -Force
        Write-Host "   ‚úÖ Frontend dist/ limpiado" -ForegroundColor Green
    }
    
    if (Test-Path $ElectronOutput) {
        Remove-Item -Path $ElectronOutput -Recurse -Force
        Write-Host "   ‚úÖ Electron build limpiado" -ForegroundColor Green
    }
    
    # Limpiar backend
    Set-Location "backend"
    dotnet clean --verbosity quiet | Out-Null
    Set-Location ".."
    Write-Host "   ‚úÖ Backend limpiado" -ForegroundColor Green
}

# Crear directorios de salida
Write-Host "`nüìÅ Preparando directorios de salida..." -ForegroundColor Yellow
New-Item -ItemType Directory -Path $OutputPath -Force | Out-Null
New-Item -ItemType Directory -Path $BackendOutput -Force | Out-Null
New-Item -ItemType Directory -Path $FrontendOutput -Force | Out-Null

# Verificar dependencias
Write-Host "`nüîç Verificando dependencias..." -ForegroundColor Yellow

try {
    $dotnetVersion = dotnet --version
    Write-Host "   ‚úÖ .NET SDK: $dotnetVersion" -ForegroundColor Green
} catch {
    Write-Host "‚ùå Error: .NET SDK no encontrado" -ForegroundColor Red
    exit 1
}

try {
    Set-Location $FrontendPath
    $nodeVersion = node --version
    $npmVersion = npm --version
    Write-Host "   ‚úÖ Node.js: $nodeVersion" -ForegroundColor Green
    Write-Host "   ‚úÖ npm: $npmVersion" -ForegroundColor Green
    Set-Location ".."
} catch {
    Write-Host "‚ùå Error: Node.js no encontrado" -ForegroundColor Red
    Set-Location ".."
    exit 1
}

# ====================================================
# BUILD BACKEND
# ====================================================
Write-Host "`n‚öôÔ∏è Building Backend (.NET)..." -ForegroundColor Green

# Restaurar paquetes
Write-Host "   üì• Restaurando paquetes NuGet..." -ForegroundColor Yellow
Set-Location "backend"
dotnet restore --verbosity quiet | Out-Null
if ($LASTEXITCODE -ne 0) {
    Write-Host "‚ùå Error restaurando paquetes NuGet" -ForegroundColor Red
    Set-Location ".."
    exit 1
}

# Ejecutar tests (opcional)
if (-not $SkipTests) {
    Write-Host "   üß™ Ejecutando tests..." -ForegroundColor Yellow
    dotnet test --verbosity quiet --no-restore | Out-Null
    if ($LASTEXITCODE -ne 0) {
        Write-Host "‚ö†Ô∏è Advertencia: Algunos tests fallaron" -ForegroundColor Yellow
        $choice = Read-Host "   ¬øContinuar con el build? (y/n)"
        if ($choice -ne 'y' -and $choice -ne 'Y') {
            Set-Location ".."
            exit 1
        }
    } else {
        Write-Host "   ‚úÖ Todos los tests pasaron" -ForegroundColor Green
    }
}

# Build y publish
Write-Host "   üî® Compilando para producci√≥n..." -ForegroundColor Yellow
dotnet publish $BackendProject -c $Configuration -o "../$BackendOutput" --verbosity quiet --no-restore | Out-Null
if ($LASTEXITCODE -ne 0) {
    Write-Host "‚ùå Error compilando backend" -ForegroundColor Red
    Set-Location ".."
    exit 1
}

Set-Location ".."
Write-Host "   ‚úÖ Backend compilado exitosamente" -ForegroundColor Green

# ====================================================
# BUILD FRONTEND
# ====================================================
Write-Host "`nüéØ Building Frontend (React + Vite)..." -ForegroundColor Green

Set-Location $FrontendPath

# Instalar dependencias si es necesario
if (-not (Test-Path "node_modules")) {
    Write-Host "   üì• Instalando dependencias npm..." -ForegroundColor Yellow
    npm install | Out-Null
    if ($LASTEXITCODE -ne 0) {
        Write-Host "‚ùå Error instalando dependencias npm" -ForegroundColor Red
        Set-Location ".."
        exit 1
    }
}

# Build web
Write-Host "   üî® Compilando aplicaci√≥n web..." -ForegroundColor Yellow
$env:NODE_ENV = "production"
npm run build | Out-Null
if ($LASTEXITCODE -ne 0) {
    Write-Host "‚ùå Error compilando frontend" -ForegroundColor Red
    Set-Location ".."
    exit 1
}

# Copiar al directorio de salida
if (Test-Path "dist") {
    Copy-Item -Path "dist/*" -Destination "../$FrontendOutput" -Recurse -Force
    Write-Host "   ‚úÖ Frontend web compilado exitosamente" -ForegroundColor Green
} else {
    Write-Host "‚ùå Error: No se encontr√≥ el directorio dist del frontend" -ForegroundColor Red
    Set-Location ".."
    exit 1
}

# Build Electron (opcional)
if ($BuildElectron) {
    Write-Host "`nüñ•Ô∏è Building aplicaci√≥n Electron..." -ForegroundColor Green
    
    Write-Host "   üì¶ Compilando aplicaci√≥n de escritorio..." -ForegroundColor Yellow
    npm run electron:build | Out-Null
    if ($LASTEXITCODE -ne 0) {
        Write-Host "‚ö†Ô∏è Advertencia: Error compilando Electron app" -ForegroundColor Yellow
    } else {
        Write-Host "   ‚úÖ Aplicaci√≥n Electron compilada" -ForegroundColor Green
        Write-Host "   üìÅ Ubicaci√≥n: $FrontendPath/dist-electron/" -ForegroundColor Cyan
    }
}

Set-Location ".."

# ====================================================
# CREAR DOCUMENTACI√ìN DE BUILD
# ====================================================
Write-Host "`nüìÑ Generando documentaci√≥n de build..." -ForegroundColor Yellow

$buildInfo = @{
    timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    configuration = $Configuration
    dotnetVersion = $dotnetVersion
    nodeVersion = $nodeVersion.TrimStart('v')
    npmVersion = $npmVersion
    electronBuild = $BuildElectron
    testsSkipped = $SkipTests
}

$buildInfoJson = $buildInfo | ConvertTo-Json -Depth 3
$buildInfoJson | Out-File -FilePath "$OutputPath/build-info.json" -Encoding UTF8

# Crear README de distribuci√≥n
$desktopSection = ""
$desktopInstructions = "No compilada en este build"

if ($BuildElectron) {
    $desktopSection = "### Aplicaci√≥n de Escritorio`n- üìÅ ``$FrontendPath/dist-electron/`` - Aplicaciones Electron compiladas"
    $desktopInstructions = "1. Distribuir ejecutables desde ``$FrontendPath/dist-electron/``"
}

$readmeContent = @"
# GESCO Desktop - Build de Producci√≥n

**Fecha de build:** $((Get-Date).ToString('dd/MM/yyyy HH:mm:ss'))
**Configuraci√≥n:** $Configuration
**Versi√≥n .NET:** $dotnetVersion  
**Versi√≥n Node.js:** $nodeVersion

## Archivos incluidos

### Backend (.NET)
- üìÅ ``backend/`` - API REST compilada
- üîß ``backend/Gesco.Desktop.UI.exe`` - Ejecutable principal
- üìã ``backend/appsettings.json`` - Configuraci√≥n

### Frontend (React)
- üìÅ ``frontend/`` - Aplicaci√≥n web compilada
- üìÑ ``frontend/index.html`` - P√°gina principal
- üì¶ ``frontend/assets/`` - Recursos est√°ticos

$desktopSection

## Instrucciones de despliegue

### Servidor Web
1. Desplegar contenido de ``frontend/`` en servidor web
2. Configurar proxy hacia API backend
3. Configurar variables de entorno de producci√≥n

### API Backend  
1. Copiar contenido de ``backend/`` al servidor
2. Configurar cadenas de conexi√≥n
3. Ejecutar: ``dotnet Gesco.Desktop.UI.dll``

### Aplicaci√≥n de Escritorio
$desktopInstructions

---
*Generado autom√°ticamente por build.ps1*
"@

$readmeContent | Out-File -FilePath "$OutputPath/README.md" -Encoding UTF8

# ====================================================
# RESUMEN FINAL
# ====================================================
Write-Host "`nüéâ BUILD COMPLETADO EXITOSAMENTE!" -ForegroundColor Green
Write-Host "=============================================" -ForegroundColor Green
Write-Host ""
Write-Host "üìä Resumen del build:" -ForegroundColor White
Write-Host "   üìÅ Output: $OutputPath/" -ForegroundColor Cyan
Write-Host "   ‚öôÔ∏è Backend: $BackendOutput/" -ForegroundColor Cyan
Write-Host "   üéØ Frontend: $FrontendOutput/" -ForegroundColor Cyan
if ($BuildElectron) {
    Write-Host "   üñ•Ô∏è Electron: $FrontendPath/dist-electron/" -ForegroundColor Cyan
}
Write-Host ""
Write-Host "üìã Archivos generados:" -ForegroundColor White
Write-Host "   üìÑ $OutputPath/build-info.json" -ForegroundColor Gray
Write-Host "   üìÑ $OutputPath/README.md" -ForegroundColor Gray
Write-Host ""

# Mostrar tama√±os de archivos
if (Test-Path $BackendOutput) {
    $backendSize = (Get-ChildItem -Path $BackendOutput -Recurse | Measure-Object -Property Length -Sum).Sum
    Write-Host "üíæ Tama√±os:" -ForegroundColor White
    Write-Host "   ‚öôÔ∏è Backend: $([Math]::Round($backendSize / 1MB, 2)) MB" -ForegroundColor Gray
}

if (Test-Path $FrontendOutput) {
    $frontendSize = (Get-ChildItem -Path $FrontendOutput -Recurse | Measure-Object -Property Length -Sum).Sum
    Write-Host "   üéØ Frontend: $([Math]::Round($frontendSize / 1MB, 2)) MB" -ForegroundColor Gray
}

if ($BuildElectron -and (Test-Path $ElectronOutput)) {
    $electronSize = (Get-ChildItem -Path $ElectronOutput -Recurse | Measure-Object -Property Length -Sum).Sum
    Write-Host "   üñ•Ô∏è Electron: $([Math]::Round($electronSize / 1MB, 2)) MB" -ForegroundColor Gray
}

Write-Host ""
Write-Host "üöÄ Para desplegar:" -ForegroundColor Yellow
Write-Host "   1. Subir contenido de '$OutputPath/' al servidor" -ForegroundColor White
Write-Host "   2. Configurar variables de entorno de producci√≥n" -ForegroundColor White
Write-Host "   3. Ejecutar: dotnet Gesco.Desktop.UI.dll" -ForegroundColor White

if ($BuildElectron) {
    Write-Host ""
    Write-Host "üñ•Ô∏è Para distribuir aplicaci√≥n de escritorio:" -ForegroundColor Yellow
    Write-Host "   üìÅ Ejecutables en: $FrontendPath/dist-electron/" -ForegroundColor White
    Write-Host "   ü™ü Windows: GESCO-Desktop-Setup.exe" -ForegroundColor White
    Write-Host "   üêß Linux: GESCO-Desktop.AppImage" -ForegroundColor White
    Write-Host "   üçé macOS: GESCO-Desktop.dmg" -ForegroundColor White
}

Write-Host "=============================================" -ForegroundColor Green